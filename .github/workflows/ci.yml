name: CI - Entrenamiento y Validaci√≥n de Modelo
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  # Job 1: Entrenar, Validar y subir como Artifact del JOB
  train-and-validate:
    runs-on: ubuntu-latest
    
    # üõë ESTE BLOQUE DEBE SER ELIMINADO:
    # outputs:
    #   runs_path: ${{ steps.prepare_runs.outputs.mlruns_path }}
      
    steps:
      - name: Clonar el repositorio
        uses: actions/checkout@v3

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Instalar dependencias
        run: pip install -r mlflow-deploy/requirements.txt 
        
      # üõë CORRECCI√ìN 1: Unificamos todo en un solo paso RUN con el working-directory
      - name: Ejecutar entrenamiento y crear carpeta mlruns
        run: |
          # Aseguramos la creaci√≥n de la carpeta mlruns DENTRO del working-directory
          mkdir -p mlruns 
          
          python src/train_LinearR.py 
          python src/train_Logistic.py
          python src/validate.py
        # AQU√ç FORZAMOS EL DIRECTORIO DE TRABAJO para que MLflow escriba en ./mlruns
        working-directory: mlflow-deploy/
        
      # √öltimo paso del Job 1: Subir artefactos como ARTEFACTO DEL JOB
      - name: Save mlruns as Job Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlruns-job-temp
          # La ruta es absoluta dentro del repositorio.
          path: mlflow-deploy/mlruns/


  # Job 2: Subir el Artefacto del JOB a GitHub Workflow
  upload-to-workflow:
    needs: train-and-validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar Artifacts del Job Anterior
        uses: actions/download-artifact@v4
        with:
          name: mlruns-job-temp
          path: mlruns_downloaded/ 

      # Esta ruta de subida es correcta ahora que garantizamos la creaci√≥n y subida consistente en el Job 1
      - name: Upload mlruns as Final Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlruns 
          path: mlruns_downloaded/ 
